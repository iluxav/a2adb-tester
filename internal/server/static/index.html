<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A2DB Playground</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        accent: '#00ff99',
                        'accent-hover': '#00ddaa',
                    }
                }
            }
        }
    </script>
    <style>
        [x-cloak] { display: none !important; }
    </style>
</head>
<body class="bg-neutral-950 text-neutral-200 min-h-screen font-sans">
    <h1 class="text-center py-5 text-accent text-2xl font-semibold">A2DB Playground</h1>

    <div class="grid grid-cols-3 gap-5 p-5" x-data="app()">
        <!-- Config Button -->
        <div class="col-span-3 text-right">
            <button @click="showConfig = true" class="px-5 py-2 bg-neutral-800 hover:bg-neutral-700 text-neutral-200 rounded-lg border border-neutral-700 transition">Config</button>
        </div>

        <!-- Config Modal -->
        <div x-show="showConfig" x-cloak class="fixed inset-0 bg-black/80 z-50 flex items-center justify-center" @click.self="showConfig = false">
            <div class="bg-neutral-900 rounded-xl p-6 w-[700px] max-w-[90vw] max-h-[90vh] overflow-y-auto border border-neutral-800" @click.stop>
                <div class="flex justify-between items-center mb-5">
                    <h2 class="text-accent text-lg font-semibold">Redis Configuration</h2>
                    <button @click="showConfig = false" class="w-8 h-8 bg-neutral-800 hover:bg-neutral-700 rounded-lg text-xl">&times;</button>
                </div>
                <p class="text-xs text-neutral-500 mb-4" x-text="configPath"></p>

                <label class="block text-sm text-neutral-400 mb-2">Redis Addresses</label>
                <div class="bg-neutral-800 rounded-lg p-3 mb-4 max-h-48 overflow-y-auto border border-neutral-700">
                    <template x-for="(addr, i) in configAddresses" :key="i">
                        <div class="flex justify-between items-center py-2 border-b border-neutral-700 last:border-0">
                            <span class="font-mono text-sm" x-text="addr"></span>
                            <button @click="removeAddress(addr)" class="px-3 py-1 bg-red-500 hover:bg-red-600 text-white text-xs rounded">Remove</button>
                        </div>
                    </template>
                    <div x-show="configAddresses.length === 0" class="text-neutral-500 text-center py-4">No addresses configured</div>
                </div>

                <div class="flex gap-3 mb-5">
                    <input type="text" x-model="newAddress" placeholder="host:port (e.g., 192.168.1.100:6379)" @keyup.enter="addAddress()" class="flex-1 px-4 py-2 bg-neutral-800 border border-neutral-700 rounded-lg focus:border-accent focus:outline-none">
                    <button @click="addAddress()" class="px-5 py-2 bg-accent hover:bg-accent-hover text-black font-semibold rounded-lg">Add</button>
                </div>

                <div class="flex items-center gap-4 mb-5">
                    <label class="text-sm text-neutral-400">Pool Size:</label>
                    <input type="number" x-model.number="configPoolSize" min="10" max="10000" class="w-28 px-3 py-2 bg-neutral-800 border border-neutral-700 rounded-lg focus:border-accent focus:outline-none">
                </div>

                <div x-show="configMessage" class="mb-4 p-3 rounded-lg text-sm" :class="configError ? 'bg-red-900/50 text-red-400' : 'bg-green-900/50 text-accent'" x-text="configMessage"></div>

                <div class="flex gap-3 justify-end">
                    <button @click="showConfig = false" class="px-5 py-2 bg-neutral-800 hover:bg-neutral-700 rounded-lg border border-neutral-700">Cancel</button>
                    <button @click="saveConfig()" class="px-5 py-2 bg-neutral-800 hover:bg-neutral-700 rounded-lg border border-neutral-700">Save</button>
                    <button @click="reconnect()" class="px-5 py-2 bg-orange-500 hover:bg-orange-600 text-white font-semibold rounded-lg">Reconnect</button>
                </div>
            </div>
        </div>

        <!-- Left: Keys List -->
        <div class="bg-neutral-900 rounded-xl p-5 border border-neutral-800">
            <h2 class="text-accent text-sm font-semibold uppercase tracking-wider mb-4">All Keys (All DBs)</h2>
            <div class="max-h-[55vh] overflow-y-auto space-y-2">
                <template x-for="item in keys" :key="item.key">
                    <div @click="selectKey(item.key)" class="flex justify-between items-center p-2 bg-neutral-800 hover:bg-neutral-700 rounded-lg cursor-pointer border border-neutral-700 transition">
                        <span class="font-mono text-sm truncate flex-1" x-text="item.key"></span>
                        <span class="flex gap-1 ml-2 items-center">
                            <template x-for="dbIdx in totalDbs" :key="dbIdx">
                                <span class="px-1.5 py-0.5 rounded text-[10px] font-bold" :class="item.databases.includes(dbIdx) ? 'bg-accent text-black' : 'bg-neutral-700 text-neutral-500'" x-text="getDbLabel(dbIdx)"></span>
                            </template>
                            <button @click.stop="deleteKey(item.key)" class="ml-1 px-1.5 py-0.5 bg-red-500 hover:bg-red-600 text-white text-[10px] rounded">X</button>
                        </span>
                    </div>
                </template>
                <div x-show="keys.length === 0" class="text-neutral-500 text-sm">No keys found</div>
            </div>
            <div class="text-xs text-neutral-500 mt-3"><span x-text="keys.length"></span> keys | Last updated: <span x-text="keysUpdated"></span></div>
        </div>

        <!-- Middle: Redis Operation -->
        <div class="bg-neutral-900 rounded-xl p-5 border border-neutral-800">
            <h2 class="text-accent text-sm font-semibold uppercase tracking-wider mb-4">Redis Operation</h2>

            <label class="block text-sm text-neutral-400 mb-1">Operation</label>
            <select x-model="operation" :disabled="loadTestRunning" class="w-full px-3 py-2 mb-3 bg-neutral-800 border border-neutral-700 rounded-lg focus:border-accent focus:outline-none">
                <option value="set">SET (set value)</option>
                <option value="incrby">INCRBY (increment by)</option>
                <option value="decrby">DECRBY (decrement by)</option>
                <option value="expire">EXPIRE (seconds)</option>
                <option value="pexpire">PEXPIRE (milliseconds)</option>
            </select>

            <label class="flex items-center gap-2 mb-3 cursor-pointer text-sm">
                <input type="checkbox" x-model="opAllDbs" :disabled="loadTestRunning" class="w-4 h-4 accent-accent">
                <span>Execute on All DBs in parallel</span>
            </label>

            <div x-show="!opAllDbs">
                <label class="block text-sm text-neutral-400 mb-1">Database</label>
                <select x-model="opDbIndex" :disabled="loadTestRunning" class="w-full px-3 py-2 mb-3 bg-neutral-800 border border-neutral-700 rounded-lg focus:border-accent focus:outline-none">
                    <option value="">ðŸŽ² Random</option>
                    <template x-for="(db, i) in databases" :key="i">
                        <option :value="i" x-text="(getReplicaName(db) || ('DB ' + i)) + ' - ' + db"></option>
                    </template>
                </select>
            </div>

            <label class="block text-sm text-neutral-400 mb-1">Key</label>
            <input type="text" x-model="opKey" placeholder="Enter key name" :disabled="loadTestRunning" class="w-full px-3 py-2 mb-3 bg-neutral-800 border border-neutral-700 rounded-lg focus:border-accent focus:outline-none">

            <label class="block text-sm text-neutral-400 mb-1" x-text="operation === 'expire' ? 'TTL (seconds)' : operation === 'pexpire' ? 'TTL (milliseconds)' : operation === 'set' ? 'Value' : 'Amount'"></label>
            <textarea x-show="operation === 'set'" x-model="opStrValue" placeholder="Enter value (supports JSON)" :disabled="loadTestRunning" class="w-full px-3 py-2 mb-3 bg-neutral-800 border border-neutral-700 rounded-lg focus:border-accent focus:outline-none min-h-[80px] resize-y"></textarea>
            <input x-show="operation !== 'set'" type="number" x-model="opValue" placeholder="1" :disabled="loadTestRunning" class="w-full px-3 py-2 mb-3 bg-neutral-800 border border-neutral-700 rounded-lg focus:border-accent focus:outline-none">

            <!-- Load Test Mode -->
            <label class="flex items-center gap-2 p-3 mb-3 bg-neutral-800 rounded-lg border border-neutral-700 cursor-pointer">
                <input type="checkbox" x-model="loadTestMode" :disabled="loadTestRunning" class="w-4 h-4 accent-orange-500">
                <span class="text-orange-400 font-medium">Load Test Mode</span>
            </label>

            <div x-show="loadTestMode" class="bg-neutral-800 p-4 rounded-lg mb-3 border border-neutral-700">
                <label class="block text-sm text-neutral-400 mb-1">Concurrent Workers</label>
                <input type="number" x-model.number="loadTestWorkers" min="1" max="1000" :disabled="loadTestRunning" class="w-full px-3 py-2 mb-3 bg-neutral-900 border border-neutral-700 rounded-lg focus:border-accent focus:outline-none">
                <label class="block text-sm text-neutral-400 mb-1">Duration (seconds)</label>
                <input type="number" x-model.number="loadTestDuration" min="1" max="3600" :disabled="loadTestRunning" class="w-full px-3 py-2 mb-3 bg-neutral-900 border border-neutral-700 rounded-lg focus:border-accent focus:outline-none">
                <div class="flex gap-2">
                    <button @click="startLoadTest()" x-show="!loadTestRunning" class="flex-1 py-2 bg-orange-500 hover:bg-orange-600 text-white font-semibold rounded-lg">Start Load Test</button>
                    <button @click="stopLoadTest()" x-show="loadTestRunning" class="flex-1 py-2 bg-red-500 hover:bg-red-600 text-white font-semibold rounded-lg">Stop</button>
                </div>

                <div x-show="loadTestRunning || loadTestStats.total > 0" class="mt-4 grid grid-cols-3 gap-2">
                    <div class="bg-neutral-900 p-2 rounded text-center border border-neutral-700">
                        <div class="text-[10px] text-neutral-500 uppercase">Total</div>
                        <div class="text-accent font-bold" x-text="loadTestStats.total.toLocaleString()"></div>
                    </div>
                    <div class="bg-neutral-900 p-2 rounded text-center border border-neutral-700">
                        <div class="text-[10px] text-neutral-500 uppercase">Errors</div>
                        <div class="font-bold" :class="loadTestStats.errors > 0 ? 'text-red-400' : 'text-accent'" x-text="loadTestStats.errors.toLocaleString()"></div>
                    </div>
                    <div class="bg-neutral-900 p-2 rounded text-center border border-neutral-700">
                        <div class="text-[10px] text-neutral-500 uppercase">RPS</div>
                        <div class="text-accent font-bold" x-text="loadTestStats.rps.toFixed(1)"></div>
                    </div>
                    <div class="bg-neutral-900 p-2 rounded text-center border border-neutral-700">
                        <div class="text-[10px] text-neutral-500 uppercase">Min</div>
                        <div class="text-accent font-bold" x-text="(loadTestStats.minLatency || 0).toFixed(2) + 'ms'"></div>
                    </div>
                    <div class="bg-neutral-900 p-2 rounded text-center border border-neutral-700">
                        <div class="text-[10px] text-neutral-500 uppercase">Avg</div>
                        <div class="text-accent font-bold" x-text="(loadTestStats.avgLatency || 0).toFixed(2) + 'ms'"></div>
                    </div>
                    <div class="bg-neutral-900 p-2 rounded text-center border border-neutral-700">
                        <div class="text-[10px] text-neutral-500 uppercase">Max</div>
                        <div class="text-accent font-bold" x-text="(loadTestStats.maxLatency || 0).toFixed(2) + 'ms'"></div>
                    </div>
                </div>
                <div class="mt-2 text-xs text-neutral-500">
                    <span x-show="loadTestRunning">Running... <span x-text="loadTestElapsed"></span>s elapsed</span>
                    <span x-show="!loadTestRunning && loadTestStats.total > 0">Completed in <span x-text="loadTestStats.duration.toFixed(1)"></span>s</span>
                </div>
            </div>

            <button x-show="!loadTestMode" @click="executeOperation()" class="w-full py-2 bg-accent hover:bg-accent-hover text-black font-semibold rounded-lg transition" x-text="'Execute ' + operation.toUpperCase()"></button>

            <div x-show="opResult && !opAllDbs && !loadTestMode" class="mt-3 p-3 rounded-lg border-l-4" :class="opError ? 'bg-red-900/30 border-red-500 text-red-400' : 'bg-green-900/30 border-accent text-accent'" x-text="opResult"></div>

            <div x-show="opResults.length > 0 && opAllDbs && !loadTestMode" class="mt-3 space-y-2">
                <template x-for="(result, i) in opResults" :key="i">
                    <div class="p-2 bg-neutral-800 rounded-lg border-l-4 border-accent">
                        <div class="text-accent text-xs" x-text="(getReplicaName(result.address) || ('DB ' + result.db_index)) + ' - ' + result.address"></div>
                        <div class="font-mono text-sm" :class="result.error ? 'text-red-400' : ''" x-text="result.error || 'Result: ' + result.result"></div>
                    </div>
                </template>
            </div>
        </div>

        <!-- Right: Watch Key -->
        <div class="bg-neutral-900 rounded-xl p-5 border border-neutral-800">
            <h2 class="text-accent text-sm font-semibold uppercase tracking-wider mb-4">Watch Key (All DBs)</h2>

            <label class="block text-sm text-neutral-400 mb-1">Key to Watch</label>
            <input type="text" x-model="watchKey" placeholder="Enter key name" @keyup.enter="startWatch()" class="w-full px-3 py-2 mb-3 bg-neutral-800 border border-neutral-700 rounded-lg focus:border-accent focus:outline-none">

            <label class="block text-sm text-neutral-400 mb-1">Interval (ms)</label>
            <input type="number" x-model.number="watchIntervalMs" min="10" placeholder="1000" class="w-full px-3 py-2 mb-3 bg-neutral-800 border border-neutral-700 rounded-lg focus:border-accent focus:outline-none">

            <div class="flex gap-2 mb-3">
                <button @click="startWatch()" class="flex-1 py-2 bg-accent hover:bg-accent-hover text-black font-semibold rounded-lg">Watch</button>
                <button @click="stopWatch()" class="flex-1 py-2 bg-neutral-800 hover:bg-neutral-700 rounded-lg border border-neutral-700">Stop</button>
            </div>

            <div x-show="watching" class="text-xs text-neutral-500 mb-2">Watching: <span x-text="watchKey"></span> (every <span x-text="watchIntervalMs"></span>ms)</div>

            <div x-show="watchResults.length > 0" class="mb-3 p-3 rounded-lg text-center font-semibold" :class="watchValuesMatch() ? 'bg-green-900/30 text-accent' : 'bg-red-900/30 text-red-400'">
                <span x-show="watchValuesMatch()">SYNC OK - All values match</span>
                <span x-show="!watchValuesMatch()">MISMATCH - Values differ!</span>
            </div>

            <div class="space-y-2">
                <template x-for="(result, i) in watchResults" :key="i">
                    <div class="p-2 bg-neutral-800 rounded-lg border-l-4" :class="!result.error && !watchValuesMatch() && result.value !== getExpectedValue() ? 'border-red-500' : 'border-accent'">
                        <div class="text-accent text-xs" x-text="(getReplicaName(result.address) || ('DB ' + result.db_index)) + ' - ' + result.address"></div>
                        <div class="font-mono text-sm break-all" :class="result.error ? 'text-red-400' : (!watchValuesMatch() && result.value !== getExpectedValue() ? 'text-red-400' : 'text-accent')" x-text="result.error || formatValue(result.value)"></div>
                    </div>
                </template>
            </div>
            <div x-show="watchResults.length > 0" class="text-xs text-neutral-500 mt-2">Last updated: <span x-text="watchUpdated"></span></div>
        </div>

        <!-- Stats Panel -->
        <div class="col-span-3 bg-neutral-900 rounded-xl p-5 border border-neutral-800">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-accent text-sm font-semibold uppercase tracking-wider">Database Stats</h2>
                <div class="flex gap-3 items-center">
                    <label class="flex items-center gap-2 text-sm cursor-pointer">
                        <input type="checkbox" x-model="statsAutoRefresh" @change="toggleStatsRefresh()" class="w-4 h-4 accent-accent">
                        <span class="text-neutral-400">Auto-refresh</span>
                    </label>
                    <button @click="fetchStats()" class="px-4 py-1.5 bg-neutral-800 hover:bg-neutral-700 rounded-lg border border-neutral-700 text-sm">Refresh</button>
                </div>
            </div>

            <div class="overflow-x-auto">
                <table class="w-full text-sm">
                    <thead>
                        <tr class="bg-neutral-800 text-left">
                            <th class="p-2 text-accent sticky left-0 bg-neutral-800">Database</th>
                            <th class="p-2 text-center text-neutral-500" colspan="2">Connections</th>
                            <th class="p-2 text-center text-neutral-500">Info</th>
                            <th class="p-2 text-center text-neutral-500" colspan="11">Commands</th>
                            <th class="p-2 text-center text-neutral-500" colspan="3">Latency (Î¼s)</th>
                            <th class="p-2 text-center text-neutral-500" colspan="6">Replication</th>
                            <th class="p-2 text-center text-neutral-500" colspan="3">Store</th>
                            <th class="p-2 text-center text-neutral-500" colspan="5">Gossip</th>
                        </tr>
                        <tr class="bg-neutral-900 text-neutral-400 text-xs">
                            <th class="p-2 sticky left-0 bg-neutral-900"></th>
                            <th class="p-2 text-center">Active</th>
                            <th class="p-2 text-center">Total</th>
                            <th class="p-2 text-center">Uptime</th>
                            <th class="p-2 text-center">INCR</th>
                            <th class="p-2 text-center">DECR</th>
                            <th class="p-2 text-center">GET</th>
                            <th class="p-2 text-center">SET</th>
                            <th class="p-2 text-center">MGET</th>
                            <th class="p-2 text-center">EXPIRE</th>
                            <th class="p-2 text-center">TTL</th>
                            <th class="p-2 text-center">KEYS</th>
                            <th class="p-2 text-center">PING</th>
                            <th class="p-2 text-center">INFO</th>
                            <th class="p-2 text-center">Other</th>
                            <th class="p-2 text-center">INCR</th>
                            <th class="p-2 text-center">GET</th>
                            <th class="p-2 text-center">SET</th>
                            <th class="p-2 text-center">Sent</th>
                            <th class="p-2 text-center">Recv</th>
                            <th class="p-2 text-center">Errors</th>
                            <th class="p-2 text-center">Avg</th>
                            <th class="p-2 text-center">Min</th>
                            <th class="p-2 text-center">Max</th>
                            <th class="p-2 text-center">Keys</th>
                            <th class="p-2 text-center">Memory</th>
                            <th class="p-2 text-center">Disk</th>
                            <th class="p-2 text-center">Alive</th>
                            <th class="p-2 text-center">Suspect</th>
                            <th class="p-2 text-center">Dead</th>
                            <th class="p-2 text-center">Sent</th>
                            <th class="p-2 text-center">Recv</th>
                        </tr>
                    </thead>
                    <tbody>
                        <template x-for="(db, i) in dbStats" :key="i">
                            <tr class="border-b border-neutral-800 hover:bg-neutral-800/50">
                                <td class="p-2 sticky left-0 bg-neutral-900">
                                    <span class="text-accent font-bold" x-text="getReplicaName(db.address) || ('DB ' + db.index)"></span>
                                    <span class="text-neutral-600 text-xs ml-1" x-show="getReplicaName(db.address)" x-text="'DB ' + db.index"></span>
                                    <br><span class="text-xs text-neutral-500" x-text="db.address"></span>
                                    <span x-show="db.error" class="text-red-400 text-xs block" x-text="db.error"></span>
                                </td>
                                <td class="p-2 text-center text-accent font-bold" x-text="db.stats?.connections?.active ?? '-'"></td>
                                <td class="p-2 text-center" x-text="db.stats?.connections?.total ?? '-'"></td>
                                <td class="p-2 text-center" x-text="db.stats ? formatUptime(db.stats.uptime_seconds || 0) : '-'"></td>
                                <td class="p-2 text-center text-accent" x-text="db.stats ? (db.stats.commands?.incr || 0).toLocaleString() : '-'"></td>
                                <td class="p-2 text-center" x-text="db.stats ? (db.stats.commands?.decr || 0).toLocaleString() : '-'"></td>
                                <td class="p-2 text-center" x-text="db.stats ? (db.stats.commands?.get || 0).toLocaleString() : '-'"></td>
                                <td class="p-2 text-center" x-text="db.stats ? (db.stats.commands?.set || 0).toLocaleString() : '-'"></td>
                                <td class="p-2 text-center" x-text="db.stats ? (db.stats.commands?.mget || 0).toLocaleString() : '-'"></td>
                                <td class="p-2 text-center" x-text="db.stats ? (db.stats.commands?.expire || 0).toLocaleString() : '-'"></td>
                                <td class="p-2 text-center" x-text="db.stats ? (db.stats.commands?.ttl || 0).toLocaleString() : '-'"></td>
                                <td class="p-2 text-center" x-text="db.stats ? (db.stats.commands?.keys || 0).toLocaleString() : '-'"></td>
                                <td class="p-2 text-center" x-text="db.stats ? (db.stats.commands?.ping || 0).toLocaleString() : '-'"></td>
                                <td class="p-2 text-center" x-text="db.stats ? (db.stats.commands?.info || 0).toLocaleString() : '-'"></td>
                                <td class="p-2 text-center" x-text="db.stats ? (db.stats.commands?.other || 0).toLocaleString() : '-'"></td>
                                <td class="p-2 text-center" x-text="db.stats ? (db.stats.latency_avg_us?.incr || 0).toLocaleString() + ' Âµs' : '-'"></td>
                                <td class="p-2 text-center" x-text="db.stats ? (db.stats.latency_avg_us?.get || 0).toLocaleString() + ' Âµs' : '-'"></td>
                                <td class="p-2 text-center" x-text="db.stats ? (db.stats.latency_avg_us?.set || 0).toLocaleString() + ' Âµs' : '-'"></td>
                                <td class="p-2 text-center" x-text="db.stats ? (db.stats.replication?.deltas_sent || 0).toLocaleString() : '-'"></td>
                                <td class="p-2 text-center" x-text="db.stats ? (db.stats.replication?.deltas_received || 0).toLocaleString() : '-'"></td>
                                <td class="p-2 text-center" :class="(db.stats?.replication?.send_errors || 0) > 0 ? 'text-red-400' : ''" x-text="db.stats ? (db.stats.replication?.send_errors || 0).toLocaleString() : '-'"></td>
                                <td class="p-2 text-center" x-text="db.stats ? (db.stats.replication?.latency_avg_ms || 0) : '-'"></td>
                                <td class="p-2 text-center" x-text="db.stats ? (db.stats.replication?.latency_min_ms || 0) : '-'"></td>
                                <td class="p-2 text-center" x-text="db.stats ? (db.stats.replication?.latency_max_ms || 0) : '-'"></td>
                                <td class="p-2 text-center" x-text="db.stats ? (db.stats.store?.keys || 0).toLocaleString() : '-'"></td>
                                <td class="p-2 text-center" x-text="db.stats?.store ? formatBytes(db.stats.store.memory_bytes || 0) : '-'"></td>
                                <td class="p-2 text-center" x-text="db.stats?.store ? formatBytes(db.stats.store.disk_bytes || 0) : '-'"></td>
                                <td class="p-2 text-center text-accent" x-text="db.stats ? (db.stats.gossip?.peers_alive || 0) : '-'"></td>
                                <td class="p-2 text-center text-yellow-400" x-text="db.stats ? (db.stats.gossip?.peers_suspect || 0) : '-'"></td>
                                <td class="p-2 text-center" :class="(db.stats?.gossip?.peers_dead || 0) > 0 ? 'text-red-400' : ''" x-text="db.stats ? (db.stats.gossip?.peers_dead || 0) : '-'"></td>
                                <td class="p-2 text-center" x-text="db.stats ? (db.stats.gossip?.messages_sent || 0).toLocaleString() : '-'"></td>
                                <td class="p-2 text-center" x-text="db.stats ? (db.stats.gossip?.messages_received || 0).toLocaleString() : '-'"></td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>
            <div x-show="statsUpdated" class="text-xs text-neutral-500 mt-2">Last updated: <span x-text="statsUpdated"></span></div>
        </div>

        <!-- Cluster Nodes -->
        <div class="col-span-3 bg-neutral-900 rounded-xl p-5 border border-neutral-800">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-accent text-sm font-semibold uppercase tracking-wider">Cluster Nodes</h2>
                <button @click="fetchCluster(); fetchStats();" class="px-4 py-1.5 bg-neutral-800 hover:bg-neutral-700 rounded-lg border border-neutral-700 text-sm">Refresh</button>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <template x-for="cluster in clusterInfo" :key="cluster.index">
                    <div class="bg-neutral-800 rounded-lg p-4 border border-neutral-700">
                        <div class="flex justify-between items-center mb-3">
                            <div>
                                <span class="text-accent font-bold text-lg" x-text="cluster.cluster?.replica_id || ('DB ' + cluster.index)"></span>
                                <span class="text-neutral-600 text-xs ml-2" x-text="'DB ' + cluster.index"></span>
                            </div>
                            <span x-show="cluster.error" class="text-red-400 text-xs" x-text="cluster.error"></span>
                        </div>
                        <div class="text-xs text-neutral-500 mb-3" x-text="cluster.address"></div>

                        <!-- Store Stats -->
                        <div class="grid grid-cols-3 gap-2 mb-3">
                            <div class="bg-neutral-900 p-2 rounded text-center">
                                <div class="text-[10px] text-neutral-500 uppercase">Keys</div>
                                <div class="text-accent font-bold text-sm" x-text="(getStatsForAddress(cluster.address)?.store?.keys || 0).toLocaleString()"></div>
                            </div>
                            <div class="bg-neutral-900 p-2 rounded text-center">
                                <div class="text-[10px] text-neutral-500 uppercase">Memory</div>
                                <div class="text-accent font-bold text-sm" x-text="formatBytes(getStatsForAddress(cluster.address)?.store?.memory_bytes || 0)"></div>
                            </div>
                            <div class="bg-neutral-900 p-2 rounded text-center">
                                <div class="text-[10px] text-neutral-500 uppercase">Disk</div>
                                <div class="text-accent font-bold text-sm" x-text="formatBytes(getStatsForAddress(cluster.address)?.store?.disk_bytes || 0)"></div>
                            </div>
                        </div>

                        <template x-if="cluster.cluster">
                            <div>
                                <div class="text-xs text-neutral-400 mb-2">
                                    <span class="text-neutral-500">Peers:</span> <span class="text-accent" x-text="cluster.cluster.peer_count || 0"></span>
                                </div>
                                <div x-show="cluster.cluster.peers && cluster.cluster.peers.length > 0" class="space-y-1">
                                    <template x-for="peer in cluster.cluster.peers" :key="peer.replica_id">
                                        <div class="flex items-center justify-between text-xs p-2 bg-neutral-900 rounded">
                                            <div>
                                                <span class="text-neutral-400" x-text="peer.replica_id"></span>
                                                <span class="text-neutral-600 ml-2" x-text="peer.address"></span>
                                            </div>
                                            <span class="px-2 py-0.5 rounded text-xs font-medium"
                                                :class="peer.state === 'Alive' ? 'bg-green-900/50 text-green-400' : peer.state === 'Suspect' ? 'bg-yellow-900/50 text-yellow-400' : 'bg-red-900/50 text-red-400'"
                                                x-text="peer.state"></span>
                                        </div>
                                    </template>
                                </div>
                                <div x-show="!cluster.cluster.peers || cluster.cluster.peers.length === 0" class="text-xs text-neutral-500 italic">No peers connected</div>
                            </div>
                        </template>
                    </div>
                </template>
            </div>
            <div x-show="clusterInfo.length === 0" class="text-neutral-500 text-sm text-center py-4">No cluster information available</div>
        </div>

        <!-- Instrumentation Metrics -->
        <div class="col-span-3 bg-neutral-900 rounded-xl p-5 border border-neutral-800">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-accent text-sm font-semibold uppercase tracking-wider">Instrumentation Metrics</h2>
                <div class="flex gap-3 items-center">
                    <label class="flex items-center gap-2 text-sm cursor-pointer">
                        <input type="checkbox" x-model="metricsAutoRefresh" @change="toggleMetricsRefresh()" class="w-4 h-4 accent-accent">
                        <span class="text-neutral-400">Auto-refresh</span>
                    </label>
                    <button @click="fetchMetrics()" class="px-4 py-1.5 bg-neutral-800 hover:bg-neutral-700 rounded-lg border border-neutral-700 text-sm">Refresh</button>
                </div>
            </div>

            <div x-show="instrumentMetrics.active_load_tests > 0" class="mb-4 p-3 bg-orange-900/30 rounded-lg text-orange-400">Active Load Tests: <span x-text="instrumentMetrics.active_load_tests"></span></div>

            <div class="overflow-x-auto">
                <table class="w-full text-sm">
                    <thead>
                        <tr class="bg-neutral-800 text-left">
                            <th class="p-2 text-accent sticky left-0 bg-neutral-800">Database</th>
                            <th class="p-2 text-center text-neutral-500" colspan="3">Connection Pool</th>
                            <th class="p-2 text-center text-neutral-500" colspan="2">Totals</th>
                            <th class="p-2 text-left text-neutral-500">Commands</th>
                        </tr>
                        <tr class="bg-neutral-900 text-neutral-400 text-xs">
                            <th class="p-2 sticky left-0 bg-neutral-900"></th>
                            <th class="p-2 text-center">Size</th>
                            <th class="p-2 text-center">Idle</th>
                            <th class="p-2 text-center">Active</th>
                            <th class="p-2 text-center">Calls</th>
                            <th class="p-2 text-center">Errors</th>
                            <th class="p-2 text-left">Details (per command)</th>
                        </tr>
                    </thead>
                    <tbody>
                        <template x-for="(db, i) in instrumentMetrics.databases || []" :key="i">
                            <tr class="border-b border-neutral-800 align-top hover:bg-neutral-800/50">
                                <td class="p-2 sticky left-0 bg-neutral-900">
                                    <span class="text-accent font-bold" x-text="getReplicaName(db.address) || ('DB ' + db.db_index)"></span>
                                    <span class="text-neutral-600 text-xs ml-1" x-show="getReplicaName(db.address)" x-text="'DB ' + db.db_index"></span>
                                    <br><span class="text-xs text-neutral-500" x-text="db.address"></span>
                                </td>
                                <td class="p-2 text-center" x-text="db.pool_size || 0"></td>
                                <td class="p-2 text-center text-neutral-500" x-text="db.pool_idle || 0"></td>
                                <td class="p-2 text-center text-accent" x-text="db.pool_active || 0"></td>
                                <td class="p-2 text-center font-bold" x-text="(db.total_calls || 0).toLocaleString()"></td>
                                <td class="p-2 text-center" :class="(db.total_errors || 0) > 0 ? 'text-red-400' : ''" x-text="(db.total_errors || 0).toLocaleString()"></td>
                                <td class="p-2">
                                    <div x-show="!db.commands || db.commands.length === 0" class="text-neutral-500">No commands recorded</div>
                                    <div class="flex flex-wrap gap-2">
                                        <template x-for="cmd in db.commands || []" :key="cmd.command">
                                            <div class="bg-neutral-800 p-2 rounded-lg min-w-[140px] border border-neutral-700">
                                                <div class="text-accent font-bold text-xs mb-1" x-text="cmd.command"></div>
                                                <div class="grid grid-cols-2 gap-x-2 text-[10px] text-neutral-400">
                                                    <span>Calls:</span><span class="text-neutral-200" x-text="cmd.total_calls.toLocaleString()"></span>
                                                    <span>Errors:</span><span :class="cmd.error_count > 0 ? 'text-red-400' : 'text-neutral-200'" x-text="cmd.error_count.toLocaleString()"></span>
                                                    <span>Avg:</span><span class="text-neutral-200" x-text="(cmd.avg_latency_us / 1000).toFixed(2) + ' ms'"></span>
                                                    <span>Min:</span><span class="text-neutral-200" x-text="(cmd.min_latency_us / 1000).toFixed(2) + ' ms'"></span>
                                                    <span>Max:</span><span class="text-neutral-200" x-text="(cmd.max_latency_us / 1000).toFixed(2) + ' ms'"></span>
                                                </div>
                                            </div>
                                        </template>
                                    </div>
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>
            <div x-show="metricsUpdated" class="text-xs text-neutral-500 mt-2">Last updated: <span x-text="metricsUpdated"></span></div>
        </div>
    </div>

    <script>
        function app() {
            return {
                showConfig: false,
                configAddresses: [],
                configPoolSize: 500,
                configPath: '',
                newAddress: '',
                configMessage: '',
                configError: false,

                databases: [],
                keys: [],
                keysUpdated: '-',
                keysInterval: null,
                totalDbs: [],

                operation: 'incrby',
                opDbIndex: 0,
                opKey: '',
                opValue: 1,
                opStrValue: '',
                opResult: '',
                opError: false,
                opAllDbs: false,
                opResults: [],

                loadTestMode: false,
                loadTestRunning: false,
                loadTestWorkers: 10,
                loadTestDuration: 10,
                loadTestElapsed: 0,
                loadTestStats: { total: 0, errors: 0, rps: 0, avgLatency: 0, duration: 0 },

                watchKey: '',
                watching: false,
                watchResults: [],
                watchUpdated: '-',
                watchInterval: null,
                watchIntervalMs: 1000,

                dbStats: [],
                statsUpdated: '',
                statsAutoRefresh: false,
                statsInterval: null,

                clusterInfo: [],

                instrumentMetrics: { databases: [], active_load_tests: 0 },
                metricsUpdated: '',
                metricsAutoRefresh: false,
                metricsInterval: null,

                async init() {
                    await this.fetchConfig();
                    await this.fetchHealth();
                    this.fetchKeys();
                    this.fetchStats();
                    this.fetchCluster();
                    this.fetchMetrics();
                    this.keysInterval = setInterval(() => this.fetchKeys(), 1000);
                    setInterval(() => { this.fetchCluster(); this.fetchStats(); }, 2000);
                    if (this.databases.length === 0) this.showConfig = true;
                },

                async fetchHealth() {
                    try {
                        const res = await fetch('/health');
                        const data = await res.json();
                        this.databases = data.databases || [];
                        this.totalDbs = this.databases.map((_, i) => i);
                    } catch (e) { console.error('Health check failed:', e); }
                },

                async fetchConfig() {
                    try {
                        const res = await fetch('/api/config');
                        const data = await res.json();
                        if (data.config) {
                            this.configAddresses = data.config.redis_addresses || [];
                            this.configPoolSize = data.config.pool_size || 500;
                        }
                        this.configPath = data.config_path || '';
                    } catch (e) { console.error('Fetch config failed:', e); }
                },

                async addAddress() {
                    if (!this.newAddress) return;
                    try {
                        const res = await fetch('/api/config/address', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ address: this.newAddress }) });
                        const data = await res.json();
                        if (data.error) { this.configMessage = data.error; this.configError = true; }
                        else { this.configMessage = data.message; this.configError = false; this.newAddress = ''; await this.fetchConfig(); }
                    } catch (e) { this.configMessage = 'Failed: ' + e.message; this.configError = true; }
                    setTimeout(() => this.configMessage = '', 5000);
                },

                async removeAddress(address) {
                    try {
                        const res = await fetch(`/api/config/address/${encodeURIComponent(address)}`, { method: 'DELETE' });
                        const data = await res.json();
                        if (data.error) { this.configMessage = data.error; this.configError = true; }
                        else { this.configMessage = data.message; this.configError = false; await this.fetchConfig(); }
                    } catch (e) { this.configMessage = 'Failed: ' + e.message; this.configError = true; }
                    setTimeout(() => this.configMessage = '', 5000);
                },

                async saveConfig() {
                    try {
                        const res = await fetch('/api/config', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ redis_addresses: this.configAddresses, pool_size: this.configPoolSize }) });
                        const data = await res.json();
                        if (data.error) { this.configMessage = data.error; this.configError = true; }
                        else { this.configMessage = data.message; this.configError = false; }
                    } catch (e) { this.configMessage = 'Failed: ' + e.message; this.configError = true; }
                    setTimeout(() => this.configMessage = '', 5000);
                },

                async reconnect() {
                    try {
                        this.configMessage = 'Reconnecting...'; this.configError = false;
                        const res = await fetch('/api/reconnect', { method: 'POST' });
                        const data = await res.json();
                        if (data.error) { this.configMessage = data.error; this.configError = true; }
                        else { this.configMessage = `Connected to ${data.databases} database(s)`; this.configError = false; await this.fetchHealth(); this.fetchKeys(); this.fetchStats(); this.fetchMetrics(); }
                    } catch (e) { this.configMessage = 'Failed: ' + e.message; this.configError = true; }
                    setTimeout(() => this.configMessage = '', 5000);
                },

                async fetchKeys() {
                    try {
                        const res = await fetch('/api/keys/all');
                        const data = await res.json();
                        this.keys = data.keys || [];
                        this.keysUpdated = new Date().toLocaleTimeString();
                    } catch (e) { console.error('Fetch keys failed:', e); }
                },

                async selectKey(key) { this.opKey = key; this.watchKey = key; await this.fetchWatchKey(); },

                async deleteKey(key) {
                    if (!confirm(`Delete "${key}" from all databases?`)) return;
                    try {
                        const res = await fetch(`/api/key/${encodeURIComponent(key)}`, { method: 'DELETE' });
                        const data = await res.json();
                        if (data.error) alert('Delete failed: ' + data.error);
                        else await this.fetchKeys();
                    } catch (e) { alert('Delete failed: ' + e.message); }
                },

                async executeOperation() {
                    if (!this.opKey) { this.opResult = 'Please enter a key'; this.opError = true; return; }
                    try {
                        let res;
                        if (this.operation === 'set') {
                            const headers = { 'Content-Type': 'application/json', ...(this.opAllDbs ? { 'X-DB-All': '1' } : { 'X-DB': String(this.opDbIndex) }) };
                            res = await fetch('/api/set', { method: 'POST', headers, body: JSON.stringify({ key: this.opKey, value: this.opStrValue }) });
                        } else {
                            const headers = this.opAllDbs ? { 'X-DB-All': '1' } : { 'X-DB': String(this.opDbIndex) };
                            res = await fetch(`/${this.operation}/${encodeURIComponent(this.opKey)}/${encodeURIComponent(this.opValue)}`, { headers });
                        }
                        const data = await res.json();
                        if (this.opAllDbs) { this.opResults = data.results || []; this.opResult = ''; }
                        else {
                            this.opResults = [];
                            if (data.error) { this.opResult = 'Error: ' + data.error; this.opError = true; }
                            else { this.opResult = `${this.operation.toUpperCase()}: ${data.result} (DB ${data.db_index})`; this.opError = false; }
                        }
                    } catch (e) { this.opResult = 'Request failed: ' + e.message; this.opError = true; this.opResults = []; }
                },

                async startLoadTest() {
                    if (!this.opKey) { alert('Please enter a key'); return; }
                    this.loadTestRunning = true; this.loadTestElapsed = 0;
                    this.loadTestStats = { total: 0, errors: 0, rps: 0, avgLatency: 0, minLatency: 0, maxLatency: 0, duration: 0 };
                    const startTime = Date.now();
                    const elapsedInterval = setInterval(() => { this.loadTestElapsed = Math.floor((Date.now() - startTime) / 1000); }, 100);
                    const isRandom = this.opDbIndex === '' || this.opDbIndex === null;
                    try {
                        const res = await fetch('/api/loadtest', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ operation: this.operation, key: this.opKey, value: parseInt(this.opValue) || 0, string_value: this.operation === 'set' ? this.opStrValue : String(this.opValue), workers: this.loadTestWorkers, duration: this.loadTestDuration, db_index: isRandom ? 0 : (parseInt(this.opDbIndex) || 0), all_dbs: this.opAllDbs, random_db: isRandom }) });
                        const data = await res.json();
                        if (data.error) alert('Load test error: ' + data.error);
                        else this.loadTestStats = { total: data.total_requests, errors: data.errors, rps: data.rps, avgLatency: data.avg_latency_ms, minLatency: data.min_latency_ms, maxLatency: data.max_latency_ms, duration: data.duration };
                    } catch (e) { alert('Load test failed: ' + e.message); }
                    clearInterval(elapsedInterval); this.loadTestRunning = false;
                },

                stopLoadTest() {},

                startWatch() {
                    if (!this.watchKey) return;
                    this.watching = true; this.fetchWatchKey();
                    if (this.watchInterval) clearInterval(this.watchInterval);
                    this.watchInterval = setInterval(() => this.fetchWatchKey(), Math.max(10, this.watchIntervalMs || 1000));
                },

                stopWatch() { this.watching = false; if (this.watchInterval) { clearInterval(this.watchInterval); this.watchInterval = null; } },

                async fetchWatchKey() {
                    if (!this.watchKey) return;
                    try {
                        const res = await fetch(`/api/key/${encodeURIComponent(this.watchKey)}/all`);
                        const data = await res.json();
                        this.watchResults = data.results || [];
                        this.watchUpdated = new Date().toLocaleTimeString();
                    } catch (e) { console.error('Watch fetch failed:', e); }
                },

                watchValuesMatch() {
                    const valid = this.watchResults.filter(r => !r.error);
                    if (valid.length < 2) return true;
                    return valid.every(r => r.value === valid[0].value);
                },

                getExpectedValue() {
                    const valid = this.watchResults.filter(r => !r.error);
                    if (valid.length === 0) return null;
                    const counts = {};
                    valid.forEach(r => { counts[r.value] = (counts[r.value] || 0) + 1; });
                    let max = 0, expected = null;
                    for (const [v, c] of Object.entries(counts)) { if (c > max) { max = c; expected = v; } }
                    return expected;
                },

                getReplicaName(address) {
                    const cluster = this.clusterInfo.find(c => c.address === address);
                    return cluster?.cluster?.replica_id || null;
                },

                getStatsForAddress(address) {
                    const stat = this.dbStats.find(s => s.address === address);
                    return stat?.stats || null;
                },

                getDbLabel(index) {
                    const db = this.databases[index];
                    if (!db) return `DB ${index}`;
                    const replica = this.getReplicaName(db);
                    return replica ? `${replica}` : `DB ${index}`;
                },

                async fetchStats() {
                    try {
                        const res = await fetch('/api/stats');
                        const data = await res.json();
                        this.dbStats = data.stats || [];
                        this.statsUpdated = new Date().toLocaleTimeString();
                    } catch (e) { console.error('Stats fetch failed:', e); }
                },

                async fetchCluster() {
                    try {
                        const res = await fetch('/api/cluster');
                        const data = await res.json();
                        this.clusterInfo = data.clusters || [];
                    } catch (e) { console.error('Cluster fetch failed:', e); }
                },

                toggleStatsRefresh() {
                    if (this.statsAutoRefresh) this.statsInterval = setInterval(() => { this.fetchStats(); this.fetchCluster(); }, 1000);
                    else if (this.statsInterval) { clearInterval(this.statsInterval); this.statsInterval = null; }
                },

                async fetchMetrics() {
                    try {
                        const res = await fetch('/api/metrics');
                        const data = await res.json();
                        this.instrumentMetrics = data;
                        this.metricsUpdated = new Date().toLocaleTimeString();
                    } catch (e) { console.error('Metrics fetch failed:', e); }
                },

                toggleMetricsRefresh() {
                    if (this.metricsAutoRefresh) this.metricsInterval = setInterval(() => this.fetchMetrics(), 1000);
                    else if (this.metricsInterval) { clearInterval(this.metricsInterval); this.metricsInterval = null; }
                },

                formatUptime(s) {
                    if (s < 60) return s + 's';
                    if (s < 3600) return Math.floor(s / 60) + 'm ' + (s % 60) + 's';
                    return Math.floor(s / 3600) + 'h ' + Math.floor((s % 3600) / 60) + 'm';
                },

                formatValue(v) {
                    if (v === null || v === undefined) return '-';
                    const n = Number(v);
                    if (!isNaN(n) && isFinite(n)) return n.toLocaleString();
                    try { return decodeURIComponent(v); } catch { return v; }
                },

                formatBytes(bytes) {
                    if (bytes === 0) return '0 B';
                    const k = 1024;
                    const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
                    const i = Math.floor(Math.log(bytes) / Math.log(k));
                    return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
                }
            };
        }
    </script>
</body>
</html>
